# 流式输出功能升级指南

本指南将帮助您更新系统以支持API流式输出功能，解决"current user api does not support http call"错误问题。

> **重要提示：** 请按照以下步骤执行升级。最新版本已添加自动数据库迁移功能，可以自动处理数据库更新。

## 1. 安装更新依赖

为了获得最佳的API调用体验，特别是流式输出支持，建议安装OpenAI客户端库：

```bash
# 在项目根目录下运行
pip install openai==1.10.0
```

您也可以直接更新所有依赖：

```bash
pip install -r requirements.txt
```

## 2. 数据库迁移（已自动化）

最新版本已添加自动数据库迁移功能，会在应用启动时自动为`api_configs`表添加`use_stream`字段。您无需手动执行此步骤。

如果您仍希望手动运行迁移脚本（通常不需要），可以执行：

```bash
# 在项目根目录下运行
python database/migration.py
```

## 3. 重启应用

重启Flask应用以应用所有更改：

```bash
# 在项目根目录下运行
python app.py
```

## 4. 配置API流式输出

登录应用后，前往"API设置"页面：

1. 点击"编辑"现有API配置，或创建新的API配置
2. 在表单中，您将看到新增的"使用流式输出(Stream)"选项
3. 勾选此选项以启用流式输出
4. 保存配置

## 5. 测试API连接

对于之前出现"current user api does not support http call"错误的API配置：

1. 编辑该API配置
2. 勾选"使用流式输出(Stream)"选项
3. 保存配置
4. 返回主页，创建新任务进行测试

## 6. 排查常见问题

如果您遇到"加载API配置失败，请刷新页面重试"错误：

1. 重启应用程序，自动迁移将尝试修复数据库问题
2. 再次尝试访问API设置页面
3. 如果问题仍然存在，检查应用日志中的具体错误信息

如果您遇到"保存API配置错误: table api_configs has no column named use_stream"：

1. 确保使用的是最新版本的应用（包含自动迁移功能）
2. 重启应用程序，等待自动迁移完成
3. 如果问题仍然存在，可以尝试手动运行迁移脚本

## 7. 适用场景说明

流式输出选项特别适用于以下情况：

- 使用阿里云通义千问API时出现"current user api does not support http call"错误
- 使用其他要求流式输出的API服务
- 当API提供商要求使用特定调用方式时

## 8. 注意事项

- 流式输出模式下，token计数是估算值，可能与实际使用量有所偏差
- 某些API服务可能在流式和非流式模式下有不同的计费标准
- 一般情况下，对于支持HTTP调用的API，推荐使用非流式模式
- 安装OpenAI客户端库后，系统会自动使用更高效和稳定的API调用方式
- 特别对于阿里云通义千问API，建议安装OpenAI客户端库并启用流式输出